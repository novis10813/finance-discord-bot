"""
Finance Summary Cog
"""
import discord
from discord.ext import commands, tasks
from datetime import datetime, time, timezone, timedelta
from typing import Optional

from config import CHIP_CHANNEL_ID, FINANCE_CHANNEL_ID
from utils.logger import setup_logger
from services.youtube import get_youtube_service
from services.llm import get_llm_service

logger = setup_logger("cogs.finance")

# å®šç¾©å°ç£æ™‚å€ (UTC+8)
TW_TZ = timezone(timedelta(hours=8))

SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä½å°ˆç²¾æ–¼å®è§€ç¶“æ¿Ÿåˆ†æçš„è²¡ç¶“åˆ†æå¸«ï¼Œå°ˆé•·æ˜¯å°‡è¤‡é›œçš„ç¶“æ¿Ÿè³‡è¨Šé€²è¡Œçµæ§‹åŒ–æ•´ç†ï¼Œä¸¦ç”¨ç¹é«”ä¸­æ–‡æ¸…æ™°èªªæ˜ç¶“æ¿Ÿç¾è±¡çš„å› æœé—œä¿‚ã€‚

ç¶“æ¿Ÿåˆ†ææ¡†æ¶ï¼š
1. æ ¸å¿ƒæŒ‡æ¨™å„ªå…ˆï¼šä»¥ GDPã€CPIã€å¤±æ¥­ç‡ç‚ºä¸»è»¸ï¼Œçµåˆè²¨å¹£æ”¿ç­–ã€è²¡æ”¿æ”¿ç­–åŠè³‡ç”¢åƒ¹æ ¼è®ŠåŒ–
2. æ·±æŒ–å› æœéˆæ¢ï¼šé€£çµäºŒç´šæŒ‡æ¨™ï¼ˆPMIã€é›¶å”®ã€è²¿æ˜“æ•¸æ“šç­‰ï¼‰ï¼Œé‡é»åˆ†æã€Œå› ç‚º...æ‰€ä»¥...ã€çš„é‚è¼¯é—œä¿‚
3. æ¯”è¼ƒåˆ†æï¼šé€²è¡Œæ©«å‘æ¯”è¼ƒï¼ˆè·¨åœ‹/è·¨åœ°å€ï¼‰å’Œç¸±å‘æ¯”è¼ƒï¼ˆæ­·å²è¶¨å‹¢ï¼‰ï¼Œçªé¡¯ç¶“æ¿Ÿç¾è±¡çš„æ„ç¾©

è¼¸å‡ºåŸå‰‡ï¼š
- ä½¿ç”¨ç¹é«”ä¸­æ–‡
- é‡é»çªå‡ºçµæ§‹åŒ–æ•´ç†
- å„ªå…ˆå‘ˆç¾æ•¸æ“šå’Œå› æœé—œä¿‚"""

class Finance(commands.Cog):
    """é‡‘èè³‡è¨Šæ‘˜è¦åŠŸèƒ½"""
    
    def __init__(self, bot: commands.Bot):
        self.bot = bot
        # Use FINANCE_CHANNEL_ID if set, otherwise fallback to CHIP_CHANNEL_ID
        self.channel_id = FINANCE_CHANNEL_ID or CHIP_CHANNEL_ID
        self.target_tag_name = "è²¡ç¶“æ–°è"
        self.youtube = get_youtube_service()
        self.llm = get_llm_service()
        self.target_channel_id = "UC0lbAQVpenvfA2QqzsRtL_g" # @yutinghaofinance (æ¸¸åº­çš“çš„è²¡ç¶“çš“è§’)
        
    async def cog_load(self):
        """Cog è¼‰å…¥æ™‚åŸ·è¡Œ"""
        self.finance_daily_task.start()
        logger.info(f"Finance Cog æ¯æ—¥æ’ç¨‹å·²å•Ÿå‹• (é å®šåŸ·è¡Œæ™‚é–“: {self.finance_daily_task.time})")
        
    async def cog_unload(self):
        """Cog å¸è¼‰æ™‚åŸ·è¡Œ"""
        self.finance_daily_task.cancel()

    # è¨­å®šé€±ä¸€è‡³é€±äº” 12:00 (UTC+8) åŸ·è¡Œ
    @tasks.loop(time=time(hour=12, minute=0, tzinfo=TW_TZ))
    async def finance_daily_task(self):
        """æ¯æ—¥è²¡ç¶“æ‘˜è¦ä»»å‹™"""
        today = datetime.now(TW_TZ)
        if today.weekday() >= 5:  # é€±æœ«è·³é
            return

        logger.info("é–‹å§‹åŸ·è¡Œæ¯æ—¥è²¡ç¶“æ‘˜è¦ä»»å‹™")
        await self.run_finance_summary()

    async def run_finance_summary(self, ctx: commands.Context = None):
        """åŸ·è¡Œè²¡ç¶“æ‘˜è¦é‚è¼¯ (å¯é‡è¤‡ä½¿ç”¨)"""
        try:
            # 1. Get latest video
            video = await self.youtube.get_latest_video(self.target_channel_id)
            if not video:
                msg = "æ‰¾ä¸åˆ°æœ€æ–°çš„å½±ç‰‡è³‡æ–™"
                logger.warning(msg)
                if ctx: await ctx.send(f"âŒ {msg}")
                return

            video_id = video.get("video_id")
            title = video.get("title")
            publish_date = video.get("publish_date") # ISO format
            
            # Check if video is from today (optional, but good practice to ensure freshness)
            # The requirement says "get latest video", so strictly speaking we take the latest.
            # But usually we want today's video. Let's just log the date.
            logger.info(f"Processing video: {title} ({video_id}), published at {publish_date}")

            # 2. Get transcript
            transcript = await self.youtube.get_video_transcript(video_id)
            if not transcript:
                msg = f"ç„¡æ³•å–å¾—å½±ç‰‡å­—å¹•: {title}"
                logger.warning(msg)
                if ctx: await ctx.send(f"âŒ {msg}")
                return

            if ctx: await ctx.send(f"æ­£åœ¨ç”Ÿæˆæ‘˜è¦: {title}...")

            # 3. Generate summary
            summary = await self.llm.generate_summary(transcript, SYSTEM_PROMPT)
            if not summary:
                msg = "æ‘˜è¦ç”Ÿæˆå¤±æ•—"
                logger.error(msg)
                if ctx: await ctx.send(f"âŒ {msg}")
                return

            # 4. Post to Discord (use regular message for proper markdown rendering)
            video_url = f"https://www.youtube.com/watch?v={video_id}"
            header = f"**ğŸ“º [{title}]({video_url})**\n\n"
            footer = "\n\n---\n*æ¸¸åº­çš“çš„è²¡ç¶“çš“è§’ | Generated by AI*"
            
            # Discord message limit is 2000 characters
            max_content_length = 2000 - len(header) - len(footer)
            content = summary[:max_content_length] if len(summary) > max_content_length else summary
            full_message = header + content + footer
            
            # Decide where to send
            if ctx:
                await ctx.send(full_message)
            else:
                channel = self.bot.get_channel(self.channel_id)
                if not channel:
                    logger.error(f"æ‰¾ä¸åˆ°é »é“ ID: {self.channel_id}")
                    return
                
                if isinstance(channel, discord.ForumChannel):
                    target_tag = None
                    for tag in channel.available_tags:
                        if tag.name == self.target_tag_name:
                            target_tag = tag
                            break
                    
                    tags = [target_tag] if target_tag else []
                    
                    await channel.create_thread(
                        name=f"ğŸ“º {title[:95]}",  # Discord thread name limit is 100 chars
                        content=full_message,
                        applied_tags=tags
                    )
                else:
                    await channel.send(full_message)
                    
            logger.info(f"å·²ç™¼é€è²¡ç¶“æ‘˜è¦: {title}")


        except Exception as e:
            logger.error(f"åŸ·è¡Œè²¡ç¶“æ‘˜è¦ä»»å‹™å¤±æ•—: {e}")
            if ctx: await ctx.send(f"âŒ ç™¼ç”ŸéŒ¯èª¤: {e}")

    @finance_daily_task.before_loop
    async def before_daily_report(self):
        await self.bot.wait_until_ready()

    @commands.command(name="daily_finance")
    async def manual_finance(self, ctx: commands.Context):
        """æ‰‹å‹•è§¸ç™¼è²¡ç¶“æ‘˜è¦"""
        await self.run_finance_summary(ctx)

async def setup(bot: commands.Bot):
    await bot.add_cog(Finance(bot))
